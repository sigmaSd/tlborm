<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Internal Rules - The Little Book of Rust Macros</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../res/code-font-patch.css">
        
        <link rel="stylesheet" href="../res/rust-syntax-bg-highlight.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../macros.html"><strong aria-hidden="true">1.</strong> Macros, A Methodical Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../macros/syntax.html"><strong aria-hidden="true">1.1.</strong> Syntax Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../macros/syntax/source-analysys.html"><strong aria-hidden="true">1.1.1.</strong> Source Analysis</a></li><li class="chapter-item expanded "><a href="../macros/syntax/ast.html"><strong aria-hidden="true">1.1.2.</strong> Macros in the Ast</a></li><li class="chapter-item expanded "><a href="../macros/syntax/expansion.html"><strong aria-hidden="true">1.1.3.</strong> Expansion</a></li></ol></li><li class="chapter-item expanded "><a href="../macros/macro_rules.html"><strong aria-hidden="true">1.2.</strong> macro_rules!</a></li><li class="chapter-item expanded "><a href="../macros/minutiae.html"><strong aria-hidden="true">1.3.</strong> Minutiae</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../macros/minutiae/fragment-specifiers.html"><strong aria-hidden="true">1.3.1.</strong> Fragment Specifiers</a></li><li class="chapter-item expanded "><a href="../macros/minutiae/metavar-and-expansion.html"><strong aria-hidden="true">1.3.2.</strong> Metavariables and Expansion Redux</a></li><li class="chapter-item expanded "><a href="../macros/minutiae/hygiene.html"><strong aria-hidden="true">1.3.3.</strong> Hygiene</a></li><li class="chapter-item expanded "><a href="../macros/minutiae/identifiers.html"><strong aria-hidden="true">1.3.4.</strong> Non-Identifier Identifiers</a></li><li class="chapter-item expanded "><a href="../macros/minutiae/debugging.html"><strong aria-hidden="true">1.3.5.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="../macros/minutiae/scoping.html"><strong aria-hidden="true">1.3.6.</strong> Scoping</a></li><li class="chapter-item expanded "><a href="../macros/minutiae/import-export.html"><strong aria-hidden="true">1.3.7.</strong> Import and Export</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../macros-practical.html"><strong aria-hidden="true">2.</strong> Macros, A Practical Introduction</a></li><li class="chapter-item expanded "><a href="../patterns.html"><strong aria-hidden="true">3.</strong> Patterns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../patterns/callbacks.html"><strong aria-hidden="true">3.1.</strong> Callbacks</a></li><li class="chapter-item expanded "><a href="../patterns/tt-muncher.html"><strong aria-hidden="true">3.2.</strong> Incremental TT Munchers</a></li><li class="chapter-item expanded "><a href="../patterns/internal-rules.html" class="active"><strong aria-hidden="true">3.3.</strong> Internal Rules</a></li><li class="chapter-item expanded "><a href="../patterns/push-down-acc.html"><strong aria-hidden="true">3.4.</strong> Push-down Accumulation</a></li><li class="chapter-item expanded "><a href="../patterns/repetition-replacement.html"><strong aria-hidden="true">3.5.</strong> Repetition Replacement</a></li><li class="chapter-item expanded "><a href="../patterns/tt-bundling.html"><strong aria-hidden="true">3.6.</strong> TT Bundling</a></li></ol></li><li class="chapter-item expanded "><a href="../building-blocks.html"><strong aria-hidden="true">4.</strong> Building Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building-blocks/ast-coercion.html"><strong aria-hidden="true">4.1.</strong> AST Coercion</a></li><li class="chapter-item expanded "><a href="../building-blocks/counting.html"><strong aria-hidden="true">4.2.</strong> Counting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building-blocks/abacus-counting.html"><strong aria-hidden="true">4.2.1.</strong> Abacus Counting</a></li></ol></li><li class="chapter-item expanded "><a href="../building-blocks/parsing.html"><strong aria-hidden="true">4.3.</strong> Parsing Rust</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Little Book of Rust Macros</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/veykril/tlborm/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#internal-rules" id="internal-rules">Internal Rules</a></h1>
<pre><pre class="playground"><code class="language-rust">#[macro_export]
macro_rules! foo {
    (@as_expr $e:expr) =&gt; {$e};

    ($($tts:tt)*) =&gt; {
        foo!(@as_expr $($tts)*)
    };
}
<span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    assert_eq!(foo!(42), 42);
</span><span class="boring">}
</span></code></pre></pre>
<p>Internal rules can be used to unify multiple macros into one, or to make it easier to read and write
<a href="./tt-muncher.html">TT Munchers</a> by explicitly naming what rule you wish to call in a macro.</p>
<p>So why is it useful to unify multiple macros into one? The main reasoning for this is how macros are
handled in the 2015 Edition of Rust due to macros not being namespaced in said edition. This gives
one the troubles of having to re-export all the internal macros as well polluting the global macro
namespace or even worse, macro name collisions with other crates. In short, it's quite a hassle.
This fortunately isn't really a problem anymore nowadays with a rustc version &gt;= 1.30, for more
information consult the <a href="/macros/minutiae/import-export.html">Import and Export chapter</a>. </p>
<p>Nevertheless, let's talk about how we can unify multiple macros into one with this technique and
what exactly this technique even is.</p>
<p>We have two macros, the common <a href="/building-blocks/ast-coercion.html"><code>as_expr!</code> macro</a> and a <code>foo</code>
macro that makes use of the first macro:</p>
<pre><pre class="playground"><code class="language-rust">#[macro_export]
macro_rules! as_expr { ($e:expr) =&gt; {$e} }

#[macro_export]
macro_rules! foo {
    ($($tts:tt)*) =&gt; {
        as_expr!($($tts)*)
    };
}
<span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    assert_eq!(foo!(42), 42);
</span><span class="boring">}
</span></code></pre></pre>
<p>This is definitely not the nicest solution we could have for this macro, as it pollutes the global
macro namespace as mentioned earlier. In this specific case <code>as_expr</code> is also a very simple macro
that we only used once, so let's &quot;embed&quot; this macro in our <code>foo</code> macro with internal rules! To do so
we simply prepend a new matcher for our macro consists of the matcher used in the <code>as_expr</code> macro,
but with a small addition. We prepend a tokentree that makes it match only when specifically asked
to. In this case we can for example use <code>@as_expr</code>, so our matcher becomes
<code>(@as_expr $e:expr) =&gt; {$e};</code>. With this we get the macro that was defined at the very top of this
page:</p>
<pre><pre class="playground"><code class="language-rust">#[macro_export]
macro_rules! foo {
    (@as_expr $e:expr) =&gt; {$e};

    ($($tts:tt)*) =&gt; {
        foo!(@as_expr $($tts)*)
    };
}
<span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    assert_eq!(foo!(42), 42);
</span><span class="boring">}
</span></code></pre></pre>
<p>You see how we embedded the <code>as_expr</code> macro in the <code>foo</code> one? All that changed is that instead of
invoking the <code>as_expr</code> macro, we now invoke <code>foo</code> recursively but with a special token tree
prepended to the arguments, <code>foo!(@as_expr $($tts)*)</code>. If you look closely you might even see that
this pattern can be combined quite nicely with <a href="./tt-muncher.html">TT Munchers</a>!</p>
<p>The reason for using <code>@</code> was that, as of Rust 1.2, the <code>@</code> token is <em>not</em> used in prefix position; as
such, it cannot conflict with anything. This reasoning became obsolete later on when in Rust 1.7
macro matchers got future proofed by emitting a warning to prevent certain tokens from being allowed
to follow certain fragments<sup class="footnote-reference"><a href="#ambiguity-restrictions">1</a></sup>, which in Rust 1.12 became a hard-error. There
other symbols or unique prefixes may be used as desired, but use of <code>@</code> has started to become
widespread, so using it may aid readers in understanding your macro.</p>
<div class="footnote-definition" id="ambiguity-restrictions"><sup class="footnote-definition-label">1</sup>
<p><a href="/macros/minutiae/metavar-and-expansion.html">ambiguity-restrictions</a></p>
</div>
<blockquote>
<p><strong>Note</strong>: in the early days of Rust the <code>@</code> token was previously used in prefix position to denote
a garbage-collected pointer, back when the language used sigils to denote pointer types. Its
only <em>current</em> purpose is for binding names to patterns. For this, however, it is used as an
<em>infix</em> operator, and thus does not conflict with its use here.</p>
</blockquote>
<p>Additionally, internal rules will often come <em>before</em> any &quot;bare&quot; rules, to avoid issues with
<code>macro_rules!</code> incorrectly attempting to parse an internal invocation as something it cannot
possibly be, such as an expression.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../patterns/tt-muncher.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../patterns/push-down-acc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../patterns/tt-muncher.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../patterns/push-down-acc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
